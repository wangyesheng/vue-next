{"version":3,"file":"reactivity.global.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["const isObject = (value: any) => typeof value === 'object' && value != null\r\nconst isArray = Array.isArray\r\nconst isFunction = (value: any) => typeof value === 'function'\r\nconst isNumber = (value: any) => typeof value === 'number'\r\nconst isString = (value: any) => typeof value === 'string'\r\nconst isIntegerKey = (key: any) => parseInt(key) + '' === key\r\nconst hasOwn = (target: object, key: PropertyKey) => Object.prototype.hasOwnProperty.call(target, key)\r\n\r\nexport {\r\n    isObject,\r\n    isArray,\r\n    isFunction,\r\n    isNumber,\r\n    isString,\r\n    isIntegerKey,\r\n    hasOwn\r\n}","import { TrackOpTypes } from \"./operators\"\r\n\r\ninterface IEffectOptions {\r\n    lazy?: boolean\r\n}\r\n\r\n// vue2.0 watcher\r\nfunction effect(fn: any, options: IEffectOptions = {}) {\r\n    const effect = createReactiveEffect(fn, options)\r\n    if (!options.lazy)\r\n        effect()\r\n    return effect\r\n}\r\n\r\nlet uid: number = 0\r\nlet activeEffect: any | undefined\r\nconst effectStack: any[] = []\r\nfunction createReactiveEffect(fn: any, options: IEffectOptions) {\r\n    const effect = function reactiveEffect() {\r\n        if (!effectStack.includes(effect)) {\r\n            try {\r\n                effectStack.push(effect)\r\n                activeEffect = effect\r\n                return fn() // fn 执行完才会去清除 effectStack 中的 effect，而 fn 执行时会进行 track 操作，所以 track 方法中的 activeEffect 永远都是当前运行的函数\r\n            } finally {\r\n                effectStack.pop()\r\n                activeEffect = effectStack[effectStack.length - 1]\r\n            }\r\n        }\r\n    }\r\n\r\n    effect.id = uid++\r\n    effect._isEffect = true\r\n    effect.raw = fn\r\n    effect.options = options\r\n\r\n    return effect\r\n}\r\n\r\nconst targetMap = new WeakMap\r\nfunction track(target: object, type: TrackOpTypes, key: PropertyKey) {\r\n    if (activeEffect == undefined) {\r\n        return\r\n    }\r\n\r\n    let depsMap = targetMap.get(target)\r\n    if (!depsMap) {\r\n        targetMap.set(target, (depsMap = new Map))\r\n    }\r\n\r\n    let deps = depsMap.get(key)\r\n    if (!deps) {\r\n        depsMap.set(key, deps = new Set)\r\n    }\r\n\r\n    if (!deps.has(activeEffect)) {\r\n        deps.add(activeEffect)\r\n    }\r\n}\r\n\r\nexport {\r\n    effect,\r\n    track\r\n}\r\n\r\n\r\n","import { hasOwn, isArray, isIntegerKey, isObject } from \"@vue/shared\"\r\nimport { track } from \"./effect\"\r\nimport { TrackOpTypes } from \"./operators\"\r\nimport { readonly, reactive } from \"./reactive\"\r\n\r\nfunction createGetter(isReadonly: boolean = false, isShallow: boolean = false) {\r\n    return function get(target: object, key: PropertyKey, receiver: any) {\r\n        const result = Reflect.get(target, key, receiver)\r\n        if (!isReadonly) {\r\n            // 依赖收集\r\n            track(target, TrackOpTypes.GET, key)\r\n        }\r\n\r\n        if (isShallow) {\r\n            return result\r\n        }\r\n\r\n        if (isObject(result)) {\r\n            return isReadonly ? readonly(result) : reactive(result)\r\n        }\r\n\r\n        return result\r\n    }\r\n}\r\n\r\nfunction createSetter(isShallow: boolean = false) {\r\n    return function set(target: object, key: PropertyKey, value: any, receiver: any) {\r\n        const result = Reflect.set(target, key, value, receiver)\r\n\r\n        const hadKey = isArray(target) && isIntegerKey(key) ? Number(key) < target.length : hasOwn(target, key)\r\n        // isArray\r\n\r\n        return result\r\n    }\r\n}\r\n\r\nconst get = createGetter()\r\nconst shallowGet = createGetter(false, true)\r\nconst readonlyGet = createGetter(true)\r\nconst shallowReadonlyGet = createGetter(true, true)\r\n\r\nconst set = createSetter()\r\nconst shallowSet = createSetter(true)\r\n\r\n\r\nconst mutableHandlers = {\r\n    get,\r\n    set\r\n}\r\nconst shallowReactiveHandlers = {\r\n    get: shallowGet,\r\n    set: shallowSet\r\n}\r\nconst readonlyHandlers = {\r\n    get: readonlyGet,\r\n    set: (target: any, key: string) => {\r\n        console.warn(`set on key ${key} falied.`)\r\n    }\r\n}\r\nconst shallowReadonlyHandlers = {\r\n    get: shallowReadonlyGet,\r\n    set: (target: any, key: string) => {\r\n        console.warn(`set on key ${key} falied.`)\r\n    }\r\n}\r\n\r\n\r\nexport {\r\n    mutableHandlers,\r\n    shallowReactiveHandlers,\r\n    shallowReadonlyHandlers,\r\n    readonlyHandlers\r\n}","import { isObject } from '@vue/shared'\r\nimport {\r\n    mutableHandlers,\r\n    shallowReactiveHandlers,\r\n    shallowReadonlyHandlers,\r\n    readonlyHandlers\r\n} from './baseHandlers'\r\n\r\nconst reactiveMap = new WeakMap, readonlyMap = new WeakMap\r\n\r\nfunction createReactiveObject(target: any, isReadonly: boolean, baseHandlers: any) {\r\n    if (!isObject(target)) {\r\n        return target\r\n    }\r\n\r\n    const proxyMap = isReadonly ? readonlyMap : reactiveMap\r\n    // 已经代理过的对象直接返回\r\n    const existProxy = proxyMap.get(target)\r\n    if (existProxy) {\r\n        return existProxy\r\n    }\r\n\r\n    const proxy = new Proxy(target, baseHandlers)\r\n\r\n    proxyMap.set(target, proxy)\r\n\r\n    return proxy\r\n}\r\n\r\nexport function reactive(target: any) {\r\n    return createReactiveObject(target, false, mutableHandlers)\r\n}\r\nexport function shallowReactive(target: any) {\r\n    return createReactiveObject(target, false, shallowReactiveHandlers)\r\n}\r\nexport function readonly(target: any) {\r\n    return createReactiveObject(target, true, readonlyHandlers)\r\n}\r\nexport function shallowReadonly(target: any) {\r\n    return createReactiveObject(target, true, shallowReadonlyHandlers)\r\n}"],"names":[],"mappings":"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"}